<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwitchHost 管理</title>
    <style>
        :root{
            --bg:#0f1217;
            --bg2:#151922;
            --sidebar:#1d232f;
            --text:#e6edf3;
            --muted:#9aa4b2;
            --primary:#3b82f6;
            --primary-600:#2563eb;
            --success:#22c55e;
            --danger:#ef4444;
            --border:#2a3240;
            --shadow:0 8px 24px rgba(0,0,0,.3);
        }
        html,body{height:100%;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
        *{box-sizing:border-box}
        a{color:inherit;text-decoration:none}

        /* 布局 */
        .layout{display:flex;height:100%;}
        aside{width:300px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;}
        .aside-header{padding:16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center}
        .logo{font-weight:600}
        .search{flex:1;position:relative}
        .search input{width:100%;padding:8px 10px 8px 32px;border:1px solid var(--border);border-radius:8px;background:var(--bg2);color:var(--text);outline:none}
        .search svg{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:16px;height:16px;stroke:var(--muted)}
        .list{flex:1;overflow:auto;padding:8px}
        #list{list-style:none;margin:0;padding:0}
        #list li{border:1px solid var(--border);border-radius:10px;margin-bottom:8px;background:var(--bg2);transition:.2s;overflow:hidden}
        #list li.active{border-color:var(--primary);box-shadow:inset 0 0 0 1px rgba(59,130,246,.3)}
        #list li .row{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer}
        #list li .title{flex:1;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        #list li .edit{padding:6px 10px;border:1px solid var(--border);border-radius:8px;color:var(--muted);opacity:.9;display:none}
        #list li:hover .edit{display:inline-block}
        .switch{display:flex;align-items:center;gap:6px}
        .switch .checkbox{width:36px;height:20px;border-radius:20px;background:#3b3f4c;position:relative;transition:.2s}
        .switch .checkbox.on{background:var(--success)}
        .switch .checkbox::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:white;transition:.2s}
        .switch .checkbox.on::after{left:18px}

        .aside-actions{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
        .btn{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg2);color:var(--text);cursor:pointer}
        .btn:hover{border-color:var(--primary);color:var(--primary)}
        .btn.primary{background:var(--primary);border-color:var(--primary);color:white}
        .btn.primary:hover{background:var(--primary-600);border-color:var(--primary-600)}
        .btn.ghost{background:transparent}

        /* 主区 */
        article{flex:1;display:flex;flex-direction:column;height:100%}
        .toolbar{position:sticky;top:0;z-index:3;background:linear-gradient(180deg,var(--bg) 70%,rgba(15,18,23,0.6));border-bottom:1px solid var(--border);padding:10px 12px;display:flex;gap:8px;align-items:center}
        .toolbar .spacer{flex:1}
        .path{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

        form.editor{flex:1;display:flex;flex-direction:column;padding:12px}
        textarea{
            flex:1;width:100%;resize:none;border:1px solid var(--border);border-radius:12px;
            background:#0b0f16;color:var(--text);padding:12px 14px;font:13px/1.6 Consolas, Monaco, 'Courier New', monospace;
            outline:none;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)
        }
        textarea:focus{border-color:var(--primary)}
        .status{padding:8px 12px;color:var(--muted);display:flex;gap:12px;align-items:center}
        .status .dot{width:8px;height:8px;border-radius:50%}
        .status.ok .dot{background:var(--success)}
        .status.err .dot{background:var(--danger)}
        .status .msg{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

        /* 弹窗 */
        .popup{position:fixed;inset:0;display:none;opacity:0;transition:.2s;z-index:20}
        .popup.show{display:block;opacity:1}
        .mask{position:absolute;inset:0;background:rgba(0,0,0,.5)}
        .popup .container{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);min-width:440px;background:var(--sidebar);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow)}
        .popup h2{padding:12px 14px;border-bottom:1px solid var(--border)}
        .popup .content{padding:16px}
        .popup .bottom{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
        .popup .close{position:absolute;right:12px;top:10px;color:var(--muted);cursor:pointer}
        .popup .close:hover{color:var(--text)}
        input[type="text"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--bg2);color:var(--text);outline:none}
        label{display:block;margin-bottom:8px;color:var(--muted)}

        @media (max-width: 960px){
            aside{width:260px}
            .toolbar{flex-wrap:wrap;gap:6px}
        }

        .row.disabled{opacity:.6;pointer-events:none}
        .btn.disabled{opacity:.6;pointer-events:none}
        .spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin-right:6px}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* 顶部加载进度条 */
        .progress{position:sticky;top:0;height:3px;background:transparent;z-index:5}
        .progress .bar{height:100%;width:0;background:var(--primary);transition:width .3s ease}
    </style>
</head>
<body>
<section class="layout">
    <aside>
        <div class="aside-header">
            <div class="logo">SwitchHost</div>
            <div class="search">
                <svg viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35m1.35-5.65a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2" stroke="currentColor" stroke-linecap="round"/></svg>
                <input id="searchInput" type="text" placeholder="搜索主机规则...">
            </div>
        </div>
        <div class="list">
            <ul id="list">
                {#(html_menu_li_list)#}
            </ul>
        </div>
        <div class="aside-actions">
            <button class="btn" onclick="showPopup('addRule')">新增规则</button>
            <button class="btn ghost" id="refreshBtn">刷新</button>
        </div>
    </aside>

    <article>
        <div class="toolbar">
            <button class="btn" id="copyBtn">复制</button>
            <button class="btn" id="applyBtn">应用到系统</button>
            <div class="spacer"></div>
            <span class="path" id="host_file_path">{#(opened_host_file_path)#}</span>
        </div>
        <div class="progress"><div id="progressBarBar" class="bar"></div></div>
        <form class="editor" action="/switchhost/api/save" method="POST" id="hostForm">
            <input type="hidden" name="id" id="save_host_id" value="0" />
            <!-- 修改默认值为 off（原为 false） -->
            <input type="hidden" name="opened" id="save_opened" value="off" />
            <textarea name="host_txt" id="save_host_txt" cols="30" rows="10" spellcheck="false">{#(opened_host_txt)#}</textarea>
            <div style="padding-top:10px;display:flex;gap:8px;justify-content:flex-end">
                <button type="submit" class="btn primary" id="saveBtn">保存</button>
                <button type="button" class="btn" id="resetBtn">重置</button>
            </div>
            <div class="status" id="statusBar"><span class="dot"></span><span class="msg">就绪</span></div>
        </form>
    </article>
</section>

<!-- 新增规则弹窗 -->
<div class="popup" id="addRule">
    <div class="mask" onclick="closePopup('addRule')"></div>
    <div class="container">
        <div class="close" onclick="closePopup('addRule')">✕</div>
        <h2>增加规则</h2>
        <div class="content">
            <label>规则标题</label>
            <input type="text" id="addInput" placeholder="例如：开发环境">
        </div>
        <p class="bottom">
            <button class="btn primary" onclick="addRule()">确定</button>
            <button class="btn" onclick="closePopup('addRule')">取消</button>
        </p>
    </div>
</div>

<!-- 编辑规则弹窗 -->
<div class="popup" id="editRule">
    <div class="mask" onclick="closePopup('editRule')"></div>
    <div class="container">
        <div class="close" onclick="closePopup('editRule')">✕</div>
        <h2>编辑规则</h2>
        <div class="content">
            <label>规则标题</label>
            <input type="text" id="editInput">
            <input type="hidden" id="editIdInput">
        </div>
        <p class="bottom">
            <button class="btn primary" onclick="editRule()">确定</button>
            <button class="btn" onclick="closePopup('editRule')">取消</button>
        </p>
    </div>
</div>

<!-- 错误提示弹窗 -->
<div class="popup" id="errorDialog">
    <div class="mask" onclick="closePopup('errorDialog')"></div>
    <div class="container">
        <div class="close" onclick="closePopup('errorDialog')">✕</div>
        <h2>保存失败</h2>
        <div class="content">
            <p><strong>错误码：</strong><span id="errCode">-</span></p>
            <p><strong>错误消息：</strong><span id="errMsg">-</span></p>
            <p><strong>原因：</strong><span id="errDetail">-</span></p>
        </div>
        <p class="bottom">
            <button class="btn primary" onclick="closePopup('errorDialog')">确定</button>
        </p>
    </div>
</div>

<script>
let _CUR_FOCUS_HOSTS_ID = 0;
const statusBar = document.getElementById('statusBar');
const statusDot = statusBar.querySelector('.dot');
const statusMsg = statusBar.querySelector('.msg');
const hostText = document.getElementById('save_host_txt');
const hostIdInput = document.getElementById('save_host_id');
const hostOpenedInput = document.getElementById('save_opened');
const pathLabel = document.getElementById('host_file_path');

let isListLoading = false;     // 左侧列表加载节流标志
let isSwitching = false;       // 应用到系统操作节流标志
let progressTimer = null;      // 顶部进度条计时器

function setStatus(ok, msg){
    statusBar.classList.toggle('ok', !!ok);
    statusBar.classList.toggle('err', !ok);
    statusMsg.textContent = msg || (ok ? '操作成功' : '发生错误');
}
function setLoading(loading, msg){
    statusBar.classList.remove('ok','err');
    statusMsg.innerHTML = loading ? ('<span class="spinner"></span>' + (msg || '加载中...')) : (msg || '就绪');
}
/* 顶部进度条控制 */
function startProgress(){
    const bar = document.getElementById('progressBarBar');
    if (!bar) return;
    clearInterval(progressTimer);
    bar.style.width = '15%';
    let w = 15;
    progressTimer = setInterval(()=>{
        w = Math.min(95, w + 10);
        bar.style.width = w + '%';
    }, 200);
}
function finishProgress(){
    const bar = document.getElementById('progressBarBar');
    if (!bar) return;
    clearInterval(progressTimer);
    bar.style.width = '100%';
    setTimeout(()=>{ bar.style.width = '0%'; }, 300);
}

/* 修复：仅新增按钮触发弹窗，左侧菜单不触发 */
function bindListEvents(){
    const listItems = document.getElementById("list").children;
    for (let i=0;i<listItems.length;i++){
        const li = listItems[i];
        // 移除模板中的内联 onclick="showPopup('addRule')"
        li.removeAttribute('onclick');

        const row = li.querySelector('a') || li;
        const edit = li.getElementsByClassName('edit')[0];
        const checkbox = li.getElementsByClassName('checkbox')[0];

        // 选中左侧规则：同步 opened 到隐藏输入
        row.onclick = function(e){
            if (e.target.classList.contains('checkbox')) return;
            if (isListLoading) return;
            isListLoading = true;
            row.classList.add('disabled');

            for (let j=0;j<listItems.length;j++){ listItems[j].classList.remove('active'); }
            li.classList.add('active');

            const span = li.getElementsByClassName('edit')[0];
            _CUR_FOCUS_HOSTS_ID = span.getAttribute("host_id");
            hostIdInput.value = _CUR_FOCUS_HOSTS_ID;

            setLoading(true,'加载中...');
            startProgress();
            fetch('/switchhost/api/get_hosts_txt?id=' + encodeURIComponent(_CUR_FOCUS_HOSTS_ID))
                .then(resp => resp.json())
                .then(data => {
                    if (!data || !data.data){
                        hostText.value = '';
                        pathLabel.textContent = '';
                        setStatus(false,'获取内容失败');
                        return;
                    }
                    hostText.value = data.data.host_txt || '';
                    pathLabel.textContent = data.data.file_path || '';
                    setLoading(false,'已加载');
                })
                .catch(()=>{
                    hostText.value = '';
                    pathLabel.textContent = '';
                    setStatus(false,'网络错误');
                })
                .finally(()=>{
                    finishProgress();
                    isListLoading = false;
                    row.classList.remove('disabled');
                });

            const isOn = !!(checkbox && checkbox.classList.contains('on'));
            updateOpenedHidden(isOn ? 'on' : 'off'); // 改为 on/off
        };

        // 切换开关：同步 opened 到隐藏输入
        if (checkbox){
            checkbox.onclick = function(){
                if (isSwitching) return;
                isSwitching = true;
                checkbox.classList.add('disabled');
                setLoading(true,'应用中...');

                startProgress();

                // 仅保持一个 on
                for(let k=0;k<listItems.length;k++){
                    const cb = listItems[k].getElementsByClassName('checkbox')[0];
                    if (cb && cb !== this){ 
                        cb.classList.remove('on'); 
                    }else {
                        hostOpenedInput.value = 'on';
                    }
                }
                this.classList.add('on');

                const willOn = !this.classList.contains('on');
                updateOpenedHidden(willOn ? 'on' : 'off'); // 改为 on/off

                const id = this.getAttribute('host_id');
                fetch('/switchhost/api/changehosts?id=' + encodeURIComponent(id))
                    .then(resp => resp.json())
                    .then(()=> setLoading(false,'已应用到系统'))
                    .catch(()=> setLoading(false,'应用失败'))
                    .finally(()=>{
                        finishProgress();
                        isSwitching = false;
                        checkbox.classList.remove('disabled');
                    });
            };
        }

        // 编辑标题：弹窗默认填入对应规则原名称（从 .title 元素读取）
        if (edit){
            edit.onclick = function(){
                const titleEl = li.querySelector('.title');
                const titleText = (titleEl?.textContent || '').trim();
                showPopup('editRule',{title:titleText,id:this.getAttribute("host_id")});
            };
        }
    }
}

/* 增加：新增与编辑规则的实现 */
function addRule(){
    const input = document.getElementById('addInput');
    const name = (input.value || '').trim();
    if (!name){ setStatus(false,'请输入规则标题'); return; }
    setLoading(true,'新增中...');
    startProgress();
    fetch('/switchhost/api/add?name='+ encodeURIComponent(name))
        .then(resp => resp.json())
        .then(() => {
            closePopup('addRule');
            location.reload();
        })
        .catch(() => setLoading(false,'新增失败'))
        .finally(()=> finishProgress());
}

function editRule(){
    const nameEl = document.getElementById('editInput');
    const idEl = document.getElementById('editIdInput');
    const name = (nameEl.value || '').trim();
    const id = idEl.value;
    if (!name){ setStatus(false,'请输入规则标题'); return; }
    setLoading(true,'修改中...');
    startProgress();
    fetch('/switchhost/api/edit?id='+encodeURIComponent(id)  + '&name='+ encodeURIComponent(name))
        .then(resp => resp.json())
        .then(() => {
            closePopup('editRule');
            // 无刷新更新左侧标题
            const items = document.getElementById('list').children;
            for (let i=0;i<items.length;i++){
                const e = items[i].getElementsByClassName('edit')[0];
                if (e && e.getAttribute('host_id') === id){
                    const titleEl = items[i].querySelector('.title');
                    if (titleEl){ titleEl.textContent = name; }
                    break;
                }
            }
            setLoading(false,'已修改');
        })
        .catch(() => setLoading(false,'修改失败'))
        .finally(()=> finishProgress());
}

function showPopup(id, data) {
    const el = document.getElementById(id);
    el.classList.add('show');
    if (id === 'editRule' && data) {
        document.getElementById('editInput').value = data.title || '';
        document.getElementById('editIdInput').value = data.id || '';
    }
}
function closePopup(id) {
    const el = document.getElementById(id);
    el.classList.remove('show');
}

function renderListEnhance(){
    // 为现有模板生成的 li 注入更现代的结构
    const ul = document.getElementById('list');
    const oldLis = Array.from(ul.children);
    oldLis.forEach(li=>{
        const spanEdit = li.getElementsByClassName('edit')[0];
        const cb = li.getElementsByClassName('checkbox')[0];
        const titleText = (spanEdit?.parentElement?.childNodes[0]?.nodeValue || '').trim();
        const id = spanEdit?.getAttribute('host_id') || '0';
        const opened = cb?.classList.contains('on') || cb?.classList.contains('off') ? cb.className : '';
        li.innerHTML = `
            <div class="row">
                <div class="title">${titleText}</div>
                <div class="switch">
                    <div host_id="${id}" class="checkbox ${opened}"></div>
                </div>
                <span class="edit" host_id="${id}">编辑</span>
            </div>
        `;
    });
    bindListEvents();
}

document.addEventListener('DOMContentLoaded',()=>{
    // 页面初始化确保隐藏输入存在
    ensureOpenedHidden();
    renderListEnhance();
    // 搜索过滤
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input',()=>{
        const q = searchInput.value.trim().toLowerCase();
        const items = document.getElementById('list').children;
        for (let i=0;i<items.length;i++){
            const titleEl = items[i].querySelector('.title');
            const t = (titleEl?.textContent || '').toLowerCase();
            items[i].style.display = t.includes(q) ? '' : 'none';
        }
    });

    // 保持“新增规则”按钮仅触发弹窗
    // （按钮已在模板中绑定 onclick="showPopup('addRule')"）

    // 复制
    document.getElementById('copyBtn').onclick = async ()=>{
        try{
            await navigator.clipboard.writeText(hostText.value || '');
            setStatus(true,'已复制到剪贴板');
        }catch(e){
            setStatus(false,'复制失败');
        }
    };

    // 应用到系统（使用当前选中或输入框中的 id）
    document.getElementById('applyBtn').onclick = ()=>{
        const id = hostIdInput.value || _CUR_FOCUS_HOSTS_ID || '0';
        if (!id) { setStatus(false,'未选择规则'); return; }

        // 置加载状态与进度条
        setLoading(true,'应用中...');
        startProgress();

        // 前端：统一关闭其他 toggle，选中当前规则并打开其开关
        const listItems = document.getElementById('list').children;
        for (let k=0;k<listItems.length;k++){
            const cb = listItems[k].getElementsByClassName('checkbox')[0];
            listItems[k].classList.remove('active');
            if (cb){ cb.classList.remove('on'); }
        }
        // 找到当前规则 li 并选中、打开
        let currentLi = null;
        for (let k=0;k<listItems.length;k++){
            const cb = listItems[k].getElementsByClassName('checkbox')[0];
            if (cb && cb.getAttribute('host_id') === String(id)){
                cb.classList.add('on');
                listItems[k].classList.add('active');
                currentLi = listItems[k];
                break;
            }
        }

        // 同步隐藏字段 opened=true
        updateOpenedHidden(true);

        // 并发：调用后端应用接口 + 获取内容刷新右侧
        const applyReq = fetch('/switchhost/api/changehosts?id=' + encodeURIComponent(id) + '&opened=on')
            .then(resp => resp.json())
            .catch(()=>({ret_code: -1, ret_msg: '应用失败'}));

        const infoReq = fetch('/switchhost/api/get_hosts_txt?id=' + encodeURIComponent(id))
            .then(resp => resp.json())
            .then(data => {
                if (data && data.data){
                    document.getElementById('save_host_txt').value = data.data.host_txt || '';
                    document.getElementById('host_file_path').textContent = data.data.file_path || '';
                    return true;
                } else {
                    document.getElementById('save_host_txt').value = '';
                    document.getElementById('host_file_path').textContent = '';
                    return false;
                }
            })
            .catch(()=>{
                document.getElementById('save_host_txt').value = '';
                document.getElementById('host_file_path').textContent = '';
                return false;
            });

        Promise.all([applyReq, infoReq])
            .then(([applyRes, infoOk])=>{
                if (applyRes && typeof applyRes.ret_code !== 'undefined' && applyRes.ret_code !== 0){
                    const filePath = (applyRes.data && applyRes.data.file_path) || '';
                    const detail = filePath ? ('系统路径：' + filePath) : ((applyRes.data && applyRes.data.error) || '');
                    showErrorDialog(applyRes.ret_code, applyRes.ret_msg || '应用失败', detail);
                    setLoading(false,'应用失败');
                } else {
                    setLoading(false,'已应用到系统');
                }
                if (!infoOk){
                    setStatus(false,'获取内容失败');
                }
            })
            .finally(()=>{
                finishProgress();
            });
    };

    // 重置编辑区到服务器内容
    document.getElementById('resetBtn').onclick = ()=>{
        const id = hostIdInput.value || _CUR_FOCUS_HOSTS_ID || '0';
        fetch('/switchhost/api/get_hosts_txt?id=' + encodeURIComponent(id))
            .then(resp => resp.json())
            .then(data => {
                hostText.value = data?.data?.host_txt || '';
                pathLabel.textContent = data?.data?.file_path || '';
                setStatus(true,'已重置到服务器内容');
            })
            .catch(()=>setStatus(false,'重置失败'));
    };

    // 刷新列表
    document.getElementById('refreshBtn').onclick = ()=>{ location.reload(); };

    // 表单提交改为AJAX：统一错误弹窗展示（包含 ret_code/ret_msg/data.file_path）
    document.getElementById('hostForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const saveBtn = document.getElementById('saveBtn');
        const resetBtn = document.getElementById('resetBtn');
        saveBtn.classList.add('disabled');
        resetBtn.classList.add('disabled');
        setLoading(true,'保存中...');
        startProgress();

        try{
            const listItems = document.getElementById('list').children;
            let openedVal = 'off'; // 修改为 on/off
            let idVal = document.getElementById('save_host_id').value || _CUR_FOCUS_HOSTS_ID || '0';
            for (let i=0;i<listItems.length;i++){
                if (listItems[i].classList.contains('active')){
                    const cb = listItems[i].getElementsByClassName('checkbox')[0];
                    openedVal = (cb && cb.classList.contains('on')) ? 'on' : 'off'; // 修改赋值
                    const spanEdit = listItems[i].getElementsByClassName('edit')[0];
                    if (spanEdit) idVal = spanEdit.getAttribute('host_id') || idVal;
                    break;
                }
            }
            updateOpenedHidden(openedVal); // 直接传 on/off

            const params = new URLSearchParams();
            params.append('id', idVal);
            params.append('host_txt', document.getElementById('save_host_txt').value || '');
            params.append('opened', openedVal); // 提交 on/off

            const resp = await fetch('/switchhost/api/save', {
                method:'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                body: params.toString()
            });
            const ct = resp.headers.get('Content-Type') || '';

            if (resp.redirected || resp.status === 301) {
                location.href = resp.url || '/switchhost/index';
                return;
            }

            if (ct.includes('application/json')) {
                const data = await resp.json();
                if (typeof data.ret_code !== 'undefined' && data.ret_code !== 0) {
                    const filePath = (data.data && data.data.file_path) || '';
                    const detail = ((data.data && data.data.error) || '') ? data.data.error : ('系统路径：' + filePath);
                    showErrorDialog(data.ret_code, data.ret_msg, detail);
                    setLoading(false,'保存失败');
                } else {
                    setLoading(false,'保存成功');
                }
            } else {
                showErrorDialog('N/A','保存失败','返回类型非JSON');
                setLoading(false,'保存失败');
            }
        } catch (err){
            showErrorDialog('N/A','网络错误', String(err));
            setLoading(false,'网络错误');
        } finally{
            finishProgress();
            saveBtn.classList.remove('disabled');
            resetBtn.classList.remove('disabled');
        }
    });
});

function showErrorDialog(code, msg, detail) {
    // 统一错误弹窗展示；若弹窗不存在则回退为 alert，避免函数未定义导致报错
    const dialog = document.getElementById('errorDialog');
    if (!dialog) {
        alert(`错误码: ${code}\n错误消息: ${msg}\n原因: ${detail || ''}`);
        return;
    }
    const codeEl = document.getElementById('errCode');
    const msgEl = document.getElementById('errMsg');
    const detailEl = document.getElementById('errDetail');
    if (codeEl) codeEl.textContent = (code ?? '-');
    if (msgEl) msgEl.textContent = (msg ?? '-');
    if (detailEl) detailEl.textContent = (detail ?? '-');
    // 依赖已有的 showPopup 打开弹窗
    showPopup('errorDialog');
}

// 添加：确保存在隐藏的 opened 输入，并提供统一的更新方法
function ensureOpenedHidden() {
    let openedInput = document.getElementById('save_opened');
    if (!openedInput) {
        const form = document.getElementById('hostForm');
        openedInput = document.createElement('input');
        openedInput.type = 'hidden';
        openedInput.name = 'opened';
        openedInput.id = 'save_opened';
        openedInput.value = 'off'; // 修改默认值
        if (form) form.appendChild(openedInput);
    }
    return openedInput;
}
function updateOpenedHidden(val) {
    const openedInput = ensureOpenedHidden();
    const isOn = (typeof val === 'string') ? (val.toLowerCase() === 'on') : !!val;
    openedInput.value = isOn ? 'on' : 'off'; // 写入 on/off
}

</script>
</body>
</html>
